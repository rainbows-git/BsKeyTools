/*
macroScript SkinIslandChecker
category: "QdzTools"
tooltip: "é£ç‚¹æ£€æŸ¥"
/*26.1.22 
    å¾…è§£å†³ï¼š
        1.é€Ÿåº¦æ…¢ã€‚
        2.åˆ¤æ–­é€»è¾‘å¾…ä¼˜åŒ–ã€‚
        3.æ˜¯ä¸æ˜¯è¦æ·»åŠ ä¿®å¤åŠŸèƒ½ã€‚
        4.UI  ã€‚   
26.1.23 
    æ›´æ–°ï¼š
        1.ä½¿ç”¨bitaryå¯¹æ¯”ä¼˜åŒ–äº†é€Ÿåº¦ã€‚
        2.ä½¿ç”¨dotnetä¸°å¯Œäº†UIã€‚
        3.æ·»åŠ æ—¥å¿—æ¡†åŠŸèƒ½ã€‚
        4.åˆ¤æ–­é€»è¾‘ä¼˜åŒ–ï¼šåªæœ‰ä¸€å—å²›çš„éª¨éª¼ä¸ç®—é£ç‚¹ã€‚
        5.é—®è®¸ï¼šå¦‚æœä¸åœ¨modfiyç•Œé¢è·å–è’™çš®ç‚¹å†…å®¹ï¼ˆä½¿ç”¨skinOpsä¸€å®šè¦åœ¨å¯¹åº”çš„ç•Œé¢ä¸‹ï¼Œå¦åˆ™è·å–çš„å†…å®¹ä¸ºç©ºï¼‰ã€‚        skinUtils.ShrinkSelection currentObjå¯ä¸åœ¨modfiyä¸‹è·å–  fn_quickGetSelectedVerts
        6.æ·»åŠ åˆç‰ˆ å³é”®èœå•ã€Šä¿®å¤ã€‹åŠŸèƒ½ã€‚
        7.æ·»åŠ ç”»åœˆæ ‡è®°åŠŸèƒ½ã€‚
        8.ä¿®æ”¹å·¦ä¸Šè§’ICONã€‚
        9.æ·»åŠ è¿›åº¦æ¡æç¤ºåŠŸèƒ½ã€‚
    
26.1.26 
    æ›´æ–°ï¼š
        1.ä½¿ç”¨é¢„ç¼“å­˜åŠŸèƒ½ä¼˜åŒ–äº†é€Ÿåº¦ã€‚
        2.ä½¿ç”¨dotnetè¿›ä¸€æ­¥ä¸°å¯Œäº†UIã€‚
        3.æ·»åŠ æ—¥å¿—æ¡†é¿å…å¼¹é”™è„šæœ¬ç»ˆæ­¢ã€‚
        4.ä¿®å¤ç©ºé€‰èŠ‚ç‚¹æŠ¥é”™é—®é¢˜ã€‚
    
26.1.27 fn_
    æ›´æ–°ï¼š
        1.æ—¥å¿—æ¡†æ”¹ä¸ºå¯Œæ–‡æœ¬æ¡†ï¼Œç”¨ä¸åŒçš„é¢œè‰²æç¤ºä¸åŒçš„æ—¥å¿—
        2.è°ƒæ•´æ—¥å¿—ï¼Œæœ€åæç¤ºçº¿&é¢&éª¨éª¼æ•°é‡ã€‚
        3.è¿›ä¸€æ­¥ä¼˜åŒ–å¤„ç†é€Ÿåº¦ã€‚bitaryã€‚
        4.æç¤ºå¤„ç†æ—¶é—´ã€‚
    
26.1.28 
    æ›´æ–°ï¼š
        1.å…¼å®¹ä½ç‰ˆæœ¬ï¼Œä½¿ç”¨ä¸åŒçš„Apiå¤„ç†ä»¥20ä¸ºåˆ†ç•Œçš„æ–‡ä»¶   ä½ç‰ˆæœ¬(ä»¥20å¾€ä¸‹)åé¢ä¸èƒ½è·Ÿå‚æ•°ï¼Œè¯†åˆ«é”™è¯¯ï¼šskinOps.GetNumberBones currentSkinMod node:currentObj
        å¾…å¤„ç†ï¼šéœ€è¦æ•´åˆä¸€ä¸‹è¿™ä¸ªä¸¤ä¸ªAPIæ–‡ä»¶ã€‚
    
26.2.2 
    æ›´æ–°ï¼š
        1.æ›´æ–°å¸®åŠ©æ–‡æ¡£ã€‚
        2.æ·»åŠ å¿½ç•¥åŠŸèƒ½ï¼Œç›®å‰ä½¿ç”¨æœ€å¤šäº”ä¸ªç‚¹è®¾è®¡å“ˆå¸Œå­—ç¬¦ä¸²æ¥å‚¨å­˜ã€‚
         ã€Bone_HatB03_Mã€‘          â† æœ‰å¿½ç•¥é¡¹ï¼Œæ˜¾ç¤ºç´«è‰²
             åŒºåŸŸ 1: 6 ä¸ªé—®é¢˜é¡¶ç‚¹   â† å·²å¿½ç•¥
             åŒºåŸŸ 2: 6 ä¸ªé—®é¢˜é¡¶ç‚¹   â† å·²ä¿®å¤
         ã€Bone_HatB01_Lã€‘          â† å…¨éƒ¨ä¿®å¤ï¼Œæ˜¾ç¤ºç»¿è‰²
             åŒºåŸŸ 1: 2 ä¸ªé—®é¢˜é¡¶ç‚¹   â† å·²ä¿®å¤
         ã€Bone_HatB02_Rã€‘          â† æœ‰æœªå¤„ç†é¡¹ï¼Œæ˜¾ç¤ºçº¢è‰²
             åŒºåŸŸ 1: 3 ä¸ªé—®é¢˜é¡¶ç‚¹   â† æœªå¤„ç†
    
26.2.3 
    æ›´æ–°ï¼š
        1.è§£å†³å¤„ç†å‡½æ•°é«˜åº¦é‡å¤çš„é—®é¢˜ã€‚
        2.æ·»åŠ åŠ¨æ€ä¿®å¤ï¼Œ1-20å‰æœŸå¿«é€Ÿä¿®å¤é£ç‚¹é—®é¢˜ï¼Œ20-50åæœŸç»†è‡´è°ƒæ•´ï¼Œé¿å…è¿‡åº¦å¹³æ»‘ã€‚
    
26.2.3 
    æ›´æ–°ï¼š
        1.MeshèŠ‚ç‚¹æ ‡è®°åŠŸèƒ½å¤±æ•ˆé‡ç½®
26.2.9
    æ›´æ–°ï¼š
        1.å°†é™¤äº†ä¸»å²›ä»¥å¤–çš„å²›åšä¸¤æ¬¡æ”¶ç¼©æµ‹è¯•
        2.å¦‚æœæ— æ³•åˆ¤æ–­å‡ºä¸»å²›çš„è¯ï¼Œåˆ—å‡ºæ‰€æœ‰çš„å²›
26.2.11
    æ›´æ–°ï¼š
        1.è®¾ç½®éª¨éª¼æ ä¸å¯é€‰
        2.å°†å¿½ç•¥å†…å®¹æ”¾åœ¨åˆ—è¡¨æœ€ä¸‹é¢
*/
--macroScript SkinIslandChecker
--category: "QdzTools"
--tooltip: "é£ç‚¹æ£€æŸ¥"
(
try (DestroyDialog ::SkinIslandChecker) catch()
rollout SkinIslandChecker "SkinIslateChecker v1.02" width:300 height:460
(
    GroupBox 'grp_object' "" pos:[10,10] width:280 height:43 
    button 'btn_help' "ğŸ—¯" pos:[280,440] width:15 height:15 
    dotNetControl 'edt_selection' "System.Windows.Forms.TextBox" pos:[20,23] width:260 height:60
    GroupBox 'grp_problems' "" pos:[10,55] width:280 height:250 
    dotNetControl 'lst_problems' "System.Windows.Forms.ListView" pos:[20,67] width:260 height:225
    progressBar 'pb3' "" pos:[10,309] width:280 height:4 color:red
    GroupBox 'grp_log' "" pos:[10,310] width:280 height:120 
    dotNetControl 'edt_log' "System.Windows.Forms.RichTextBox" pos:[20,323] width:260 height:95
    dotNetControl 'contextMenu' "System.Windows.Forms.ContextMenuStrip"
    button 'btn_check' "æ£€ æŸ¥" pos:[20,435] width:120 height:20 toolTip:"å·¦é”®å•å‡»ç²¾ç¡®æ£€æŸ¥ï¼Œå³é”®å•å‡»å®½æ³›æ£€æŸ¥..."  --images:#("FileLinkActionItems_24i.bmp","FileLinkActionItems_24i.bmp",9,3,4,0,0,false,true) 
    button 'btn_clear' "æ¸… é™¤" pos:[160,435] width:120 height:20  toolTip:"å·¦é”®å•å‡»é‡ç½®åˆ—è¡¨ï¼Œå³é”®å•å‡»æ¸…æ¥šé€‰æ‹©æ ‡è®°..."
    local problemBones = #()
    local logText = ""
    local currentObj = undefined
    local currentSkinMod = undefined
    local vertexDataMap = #()
    local markedVertices = #()
    local roundInfoList = #()
    local ignoredRegions = #()   -- å­˜å‚¨è¢«å¿½ç•¥çš„åŒºåŸŸï¼Œé‡å¼€è„šæœ¬é‡ç½®
    local fixedRegions = #()     -- ä¸´æ—¶ï¼Œå­˜å‚¨æœ¬æ¬¡æ£€æŸ¥ä¸­è¢«ä¿®å¤çš„åŒºåŸŸï¼ˆé‡æ–°æ£€æŸ¥æ—¶æ¸…ç©ºï¼‰

    fn fn_helpText =
    (
        messageBox "è’™çš®é£ç‚¹æ£€æŸ¥å·¥å…·ä½¿ç”¨è¯´æ˜:\n
        1.é€‰æ‹©è’™çš®çš„æ¨¡å‹ã€‚(å¤šé€‰ä¹Ÿåªå¤„ç†ç¬¬ä¸€ä¸ª) \n
        2.ç‚¹å‡»â‰®æ£€ æŸ¥â‰¯å¼€å§‹æ£€æŸ¥å°è¯•æ£€æŸ¥è’™çš®é—®é¢˜ã€‚\n          æ£€æŸ¥æœ‰ä¸¤ç§æ–¹å¼â‰®å·¦é”®ç‚¹å‡»â‰¯å®½æ³›æ£€æŸ¥ï¼Œâ‰®å³é”®ç‚¹å‡»\n          â‰¯ç»†è‡´æ£€æŸ¥ã€‚(å»ºè®®ä½¿ç”¨å®½æ³›æ£€æŸ¥)\n
        3.å¦‚æœ‰é—®é¢˜ï¼Œâ‰®åŒå‡»â‰¯åŒºåŸŸå¯è·³è½¬è‡³é—®é¢˜è’™çš®ç‚¹å¹¶æ ‡\n          è®°ï¼Œâ‰®å³é”®ç‚¹å‡»â‰¯å¯é€‰æ‹©ä¿®å¤ï¼ˆæœ€å¥½ä¿®å¤å®Œè‡ªå·±æ£€æŸ¥\n          ä¸€ä¸‹ï¼‰ã€‚â‰®ç‚¹å‡»å¿½ç•¥â‰¯å¯æ ‡è®°å‡ºæ¥ä¸ºç´«è‰²,ä¸å…³é—­è„š\n          æœ¬ä¸‹æ¬¡æ£€æŸ¥ä¾ç„¶ç”Ÿæ•ˆã€‚\n
        4.å³é”®ç‚¹å‡»â‰®æ¸… é™¤â‰¯å¯ä»¥ä¸´æ—¶æ¸…é™¤è’™çš®ç‚¹æ ‡è®°ï¼Œ\n          å·¦ä¾§ç‚¹å‡»æ¸…é™¤é‡ç½®æ‰€æœ‰èŠ‚ç‚¹ã€‚\n
        5.è„šæœ¬ä»¥2020åˆ†ç•Œä½¿ç”¨ä¸åŒçš„Apiä½ç‰ˆæœ¬è¿è¡Œé€Ÿåº¦ç›¸æ¯”\n          é«˜ç‰ˆæœ¬æ…¢2~5å€å·¦å³ã€‚ä½¿ç”¨20åŠä»¥åç‰ˆæœ¬è·å¾—æ›´ä¼˜\n          ä½“éªŒã€‚\n
                                                                Byï¼šè™¹ 
        " title:"ä½¿ç”¨è¯´æ˜" beep:false fgcolor:[100,200,100]
    )
    fn fn_getVertexHash boneName vertArray = ( --ä½¿ç”¨éª¨éª¼åç§°ä¸æœ€å¤šå‰äº”ä¸ªç‚¹ç»„æˆå”¯ä¸€å“ˆå¸Œå­—ç¬¦ä¸² ç”¨æ¥æ ‡è®°å¿½ç•¥åŒºåŸŸ
        -- æ’åºé¡¶ç‚¹æ•°ç»„ä»¥ç¡®ä¿ä¸€è‡´æ€§
        local sortedVerts = sort (deepCopy vertArray)
        -- å–å‰å‡ ä¸ªé¡¶ç‚¹å’Œæ€»æ•°ä½œä¸ºç­¾åï¼ˆé¿å…å­—ç¬¦ä¸²è¿‡é•¿ï¼‰
        local hashStr = boneName + "_"
        hashStr += sortedVerts.count as string + "_"
        -- å–æœ€å¤šå‰5ä¸ªé¡¶ç‚¹ID(æ•°é‡å·²ç»è¶³å¤ŸåŒºåˆ†ï¼Œæå°‘æ•°æƒ…å†µä¸‹ä¼šå†²çªï¼Œä¹Ÿæ˜¯èŠ‚çœæ€§èƒ½)
        local sampleCount = amin #(5, sortedVerts.count)
        for i = 1 to sampleCount do
            hashStr += sortedVerts[i] as string + "_"
        return hashStr
    )
    --è·å–ä¸€ä¸‹ç‰ˆæœ¬ç”¨æ¥ä½¿ç”¨ä¸åŒçš„APIå¤„ç†
    fn fn_getMaxVersion =(
        maxVes = ((maxVersion())[1] / 1000 + 1998)
        return (maxVes as integer)
    )
    -- æ ‡è®°ä¸€ä¸‹å·¦ä¸Šè§’Icon
    fn fn_string2Bmp string = (
        clipboardClass = dotNetClass "System.Windows.Forms.Clipboard"
        ConvertClass = dotnetclass "system.convert"
        imageclass = dotNetclass "System.Drawing.image"
        bytearr = convertclass.FromBase64String string
        memstream = dotnetobject "System.IO.MemoryStream" bytearr
        DecodedImg = ImageClass.fromstream memstream
        memstream.close()
        DecodedImg
    )
    fn fn_loadMyLogoAsTitlebarIcon = (
        logoIcon = "iVBORw0KGgoAAAANSUhEUgAAAC8AAAAwCAYAAACBpyPiAAAACXBIWXMAAAsTAAALEwEAmpwYAAAF82lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNi4wLWMwMDMgMTE2LmRkYzdiYzQsIDIwMjEvMDgvMTctMTM6MTg6MzcgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIiB4bWxuczpwaG90b3Nob3A9Imh0dHA6Ly9ucy5hZG9iZS5jb20vcGhvdG9zaG9wLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdEV2dD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlRXZlbnQjIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCAyMS4yIChXaW5kb3dzKSIgeG1wOkNyZWF0ZURhdGU9IjIwMjYtMDItMDJUMTc6NTc6NTgrMDg6MDAiIHhtcDpNb2RpZnlEYXRlPSIyMDI2LTAyLTAyVDE4OjAyOjM5KzA4OjAwIiB4bXA6TWV0YWRhdGFEYXRlPSIyMDI2LTAyLTAyVDE4OjAyOjM5KzA4OjAwIiBkYzpmb3JtYXQ9ImltYWdlL3BuZyIgcGhvdG9zaG9wOkNvbG9yTW9kZT0iMyIgcGhvdG9zaG9wOklDQ1Byb2ZpbGU9InNSR0IgSUVDNjE5NjYtMi4xIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjk5M2MyNzRkLWEzN2YtM2Y0Yi04OTc2LTAzMGUxNzY3MzcyOSIgeG1wTU06RG9jdW1lbnRJRD0iYWRvYmU6ZG9jaWQ6cGhvdG9zaG9wOmMwZGZkN2EwLTJhMTktZjQ0NC04NWVjLWIwZTU3MTdjNmZjYiIgeG1wTU06T3JpZ2luYWxEb2N1bWVudElEPSJ4bXAuZGlkOjliMTIzM2NkLTA5YmEtMTM0Yi1iZDg1LTdhY2E3ZjFjMDQyMSI+IDx4bXBNTTpIaXN0b3J5PiA8cmRmOlNlcT4gPHJkZjpsaSBzdEV2dDphY3Rpb249ImNyZWF0ZWQiIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6OWIxMjMzY2QtMDliYS0xMzRiLWJkODUtN2FjYTdmMWMwNDIxIiBzdEV2dDp3aGVuPSIyMDI2LTAyLTAyVDE3OjU3OjU4KzA4OjAwIiBzdEV2dDpzb2Z0d2FyZUFnZW50PSJBZG9iZSBQaG90b3Nob3AgMjEuMiAoV2luZG93cykiLz4gPHJkZjpsaSBzdEV2dDphY3Rpb249InNhdmVkIiBzdEV2dDppbnN0YW5jZUlEPSJ4bXAuaWlkOjk5M2MyNzRkLWEzN2YtM2Y0Yi04OTc2LTAzMGUxNzY3MzcyOSIgc3RFdnQ6d2hlbj0iMjAyNi0wMi0wMlQxODowMjozOSswODowMCIgc3RFdnQ6c29mdHdhcmVBZ2VudD0iQWRvYmUgUGhvdG9zaG9wIDIxLjIgKFdpbmRvd3MpIiBzdEV2dDpjaGFuZ2VkPSIvIi8+IDwvcmRmOlNlcT4gPC94bXBNTTpIaXN0b3J5PiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PvHAf+AAAAsmSURBVGiB7Zp5jF3Vfcc/5+5vn3lvdns8HhsvOC7GMI5xDA1ODBEBQpPgNBGEqEppTVqSVKKBtqkyaRVQlEhkcRKJSkGNHGKgSZRgCAZiO1AzDnYj4/E+XsYz4/HMvDdvm7fc5d17+k/HOMX2eHkIIeX77z339/3od3/3nN895wopJe9VKe82wJXoPQ2vAQgh3pHg/7B/OJnVrVWucCIW1W1PLliQrkfc6VJ/xzLfu39/tNjQsfugq2we1Bqf9mKzN/Xu3h2up8c7Bl9uX/LT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"
        d = (windows.getChildHWND 0 ::SkinIslandChecker.title)[1]
        WM_SETICON = 0x0080
        ICON_SMALL = 0
        bm = dotnetobject "System.Drawing.Bitmap" (fn_string2Bmp logoIcon)         
        ptr = bm.GetHicon()
        icon = (dotnetclass "System.Drawing.Icon").FromHandle (dotnetobject "IntPtr" ptr)           
        windows.SendMessage d WM_SETICON ICON_SMALL icon.handle
    )
    -- åˆå§‹åŒ–é€‰æ‹©å¯¹è±¡æ–‡æœ¬æ¡†
    fn fn_initSelectionControl = (
        edt_selection.BackColor = (dotNetClass "System.Drawing.Color").FromArgb 43 43 43
        edt_selection.ForeColor = (dotNetClass "System.Drawing.Color").FromArgb 255 180 180
        edt_selection.BorderStyle = (dotNetClass "System.Windows.Forms.BorderStyle").None
        edt_selection.Font = dotNetObject "System.Drawing.Font" "Microsoft YaHei UI" 10
        edt_selection.ReadOnly = true
        edt_selection.Text = "æœªé€‰æ‹©å¯¹è±¡..."
        edt_selection.TextAlign = (dotNetClass "System.Windows.Forms.HorizontalAlignment").Left 
    )
    -- ä¿®æ”¹åˆå§‹åŒ–åˆ—è¡¨æ§ä»¶å‡½æ•°
    fn fn_initListControl = (
        lst_problems.BackColor = (dotNetClass "System.Drawing.Color").FromArgb 43 43 43
        lst_problems.ForeColor = (dotNetClass "System.Drawing.Color").FromArgb 200 200 200
        lst_problems.BorderStyle = (dotNetClass "System.Windows.Forms.BorderStyle").None
        lst_problems.Font = dotNetObject "System.Drawing.Font" "Microsoft YaHei UI" 10
        lst_problems.View = (dotNetClass "System.Windows.Forms.View").Details
        lst_problems.FullRowSelect = true
        lst_problems.GridLines = false
        lst_problems.HeaderStyle = (dotNetClass "System.Windows.Forms.ColumnHeaderStyle").None
        lst_problems.OwnerDraw = true            
        lst_problems.Columns.Add "" 360
        local menuItem = contextMenu.Items.Add "â€¢   é€‰æ‹©    "
        local menuItem = contextMenu.Items.Add "â€¢   ä¿®å¤    "
        local menuItem = contextMenu.Items.Add "â€¢   å¿½ç•¥    "
        local menuItem = contextMenu.Items.Add "â€¢   å–æ¶ˆå¿½ç•¥    "
        local menuItem = contextMenu.Items.Add "â€¢   å…¨é€‰    "
        menuItem.Font = dotNetObject "System.Drawing.Font" "Microsoft YaHei UI" 9
    )
    -- åˆå§‹åŒ–æ—¥å¿—æ§ä»¶
    fn fn_initLogControl = (
        edt_log.Multiline = true
        edt_log.ReadOnly = true
        edt_log.ScrollBars = (dotNetClass "System.Windows.Forms.RichTextBoxScrollBars").Vertical
        edt_log.BackColor = (dotNetClass "System.Drawing.Color").FromArgb 43 43 43
        edt_log.ForeColor = (dotNetClass "System.Drawing.Color").FromArgb 144 238 144
        edt_log.BorderStyle = (dotNetClass "System.Windows.Forms.BorderStyle").none
        edt_log.Font = dotNetObject "System.Drawing.Font" "Consolas" 9
        edt_log.DetectUrls = false
        --edt_log.WordWrap = false  -- ä¸è‡ªåŠ¨æ¢è¡Œ
    )
    --æ—¥å¿— ï¼šæ ¹æ®ä¸åŒçš„æ“ä½œè¿”å›ä¸åŒé¢œè‰²çš„æ—¥å¿—
    fn fn_addLog msg level:#info = ( --level:#success
        try 
        (
            local colorClass = dotNetClass "System.Drawing.Color"
            local color = case level of (
                #error:   colorClass.FromArgb 255 10 10
                #warning: colorClass.FromArgb 255 100 100
                #success: colorClass.FromArgb 144 238 144
                #info:    colorClass.FromArgb 90 200 200
            )
            local t = getLocalTime()
            local timeStr = "[" + (formattedPrint t[5] format:"02d") + ":" + (formattedPrint t[6] format:"02d") + ":" + (formattedPrint t[7] format:"02d") + "]"
            local logEntry = timeStr + "â€¢" + msg
        
            local startPos = edt_log.TextLength

            edt_log.AppendText logEntry

            local actualLength = edt_log.TextLength - startPos
            edt_log.Select startPos actualLength
            edt_log.SelectionColor = color

            edt_log.AppendText "\r\n"
            
            edt_log.SelectionStart = edt_log.TextLength
            edt_log.ScrollToCaret()
        ) 
        catch 
        (
            format "æ—¥å¿—é”™è¯¯: %\n" (getCurrentException())
        )
    )
    fn fn_clearIni = (
        edt_log.Clear()
        lst_problems.Items.Clear()
        problemBones = #()
        vertexDataMap = #()
        markedVertices = #()
        roundInfoList = #()
        ignoredRegions = #()    -- æ¸…é™¤å¿½ç•¥åˆ—è¡¨
        fixedRegions = #()      -- æ¸…é™¤ä¿®å¤åˆ—è¡¨
        edt_selection.Text = "æœªé€‰æ‹©å¯¹è±¡..."
        currentObj = undefined
        currentSkinMod = undefined
        pb3.value = 0
        completeRedraw()
        fn_addLog "å·²æ¸…é™¤æ‰€æœ‰æ•°æ®ã€‚" level:#success 
        fn_addLog  "é€‰æ‹©è’™çš®å¯¹è±¡,ç‚¹å‡»æ£€æŸ¥æŒ‰é’®å¼€å§‹" level:#success 
        fn_addLog "å¯ä½¿ç”¨å·¦é”®/å³é”®ä¸¤ç§æ£€æŸ¥æ–¹å¼ã€‚" level:#success
    )
    --è·å–ç‚¹å‘¨ï¼ˆæ ¸
    fn fn_getVertexRing obj vertIndex = 
    (
        local neighborVerts = #()
        local edges = meshop.getEdgesUsingVert obj vertIndex as array
        
        for e in edges do
        (
            local verts = meshop.getVertsUsingEdge obj #{e} as array

            if verts[1] == vertIndex then
                append neighborVerts verts[2]
            else
                append neighborVerts verts[1]
        )
        append neighborVerts vertIndex
        
        return neighborVerts
    )
    -- æ±‚å’Œæ•°ç»„
    fn fn_sumArray arr = (
        local total = 0.0
        for v in arr do total += v
        return total
    )
    -- è·å–é¡¶ç‚¹æƒé‡
    fn fn_getVertexWeights vid = (
        local boneList = #()
        local weightList = #()
        local numWeights = skinOps.GetVertexWeightCount currentSkinMod vid
        
        for i = 1 to numWeights do 
        (
            local boneID = skinOps.GetVertexWeightBoneID currentSkinMod vid i
            local weight = skinOps.GetVertexWeight currentSkinMod vid i
            if weight > 0.0001 then
            (
                append boneList boneID
                append weightList weight
            )
        )
        return #(boneList, weightList)
    )
    -- å¿«é€Ÿè·å–é€‰ä¸­é¡¶ç‚¹ ID æ•°ç»„ ï¼ˆå…¼å®¹ä½ç‰ˆæœ¬  ä½ç‰ˆæœ¬skinOpsä¸èƒ½ç›´æ¥æ ¹æ®éª¨éª¼IDè·å–è’™çš®ç‚¹
    fn fn_quickGetSelectedVerts skinMod =
    (
        local sel = #()
        local n = skinOps.GetNumberVertices skinMod
        for i = 1 to n where skinOps.IsVertexSelected skinMod i do
            append sel i
        return sel
    )
    -- è·å–å—å½±å“çš„é¡¶ç‚¹ï¼ˆåŒ…æ‹¬å‘¨å›´é¡¶ç‚¹ï¼‰
    fn fn_meshGetAffectedVerts vidList = (
        local result = deepCopy vidList
        for vid in vidList do 
        (
            local ringVerts = fn_getVertexRing currentObj vid
            for rv in ringVerts do 
            (
                if findItem result rv == 0 do
                    append result rv
            )
        )
        return result
    )
   -- è·å–é¡¶ç‚¹å‘¨å›´ä¿¡æ¯
    fn fn_getVertRoundDisWeightsInfo vid = (
        local ringVerts = fn_getVertexRing currentObj vid
        local idx = findItem ringVerts vid
        if idx > 0 do deleteItem ringVerts idx
        return #(ringVerts)
    )
   -- æ›¿æ¢é¡¶ç‚¹æƒé‡
    fn fn_skinReplaceVertexWeights skinMod vid boneList weightList = (
        local total = fn_sumArray weightList
        if total > 0.0001 then 
        (
            for i = 1 to weightList.count do
                weightList[i] = weightList[i] / total
            skinOps.ReplaceVertexWeights skinMod vid boneList weightList
        )
    )
    
   -- Laplacianå¹³æ»‘ç®—æ³• æ··åˆé¡¶ç‚¹æƒé‡å‡½æ•°(ä¿®å¤ç”¨) å°†é€‰å®šé¡¶ç‚¹çš„æƒé‡ä¸å…¶å‘¨å›´é¡¶ç‚¹çš„æƒé‡è¿›è¡Œæ··åˆï¼Œä»è€Œå¹³æ»‘è¿‡æ¸¡è’™çš®æƒé‡
    /* 
    æ–°æƒé‡ = (å‘¨å›´é¡¶ç‚¹å¹³å‡æƒé‡ Ã— æ··åˆå¼ºåº¦) + (åŸæƒé‡ Ã— (1 - æ··åˆå¼ºåº¦))
    è¾“å…¥: vidList=[10], valList=[0.7]
    â†“
    è·å–å—å½±å“é¡¶ç‚¹: [8,9,10,11,12]
    â†“
    é¢„ç¼“å­˜æ‰€æœ‰é¡¶ç‚¹çš„æƒé‡æ•°æ®
    â†“
    å¯¹äºé¡¶ç‚¹10:
    â”œâ”€ è·å–å‘¨å›´é¡¶ç‚¹ [8,9,11,12]
    â”œâ”€ è®¡ç®—å‘¨å›´4ä¸ªé¡¶ç‚¹çš„å¹³å‡æƒé‡
    â”œâ”€ å‘¨å›´æƒé‡ Ã— 0.7
    â”œâ”€ åŸæƒé‡ Ã— 0.3
    â””â”€ åˆå¹¶å¹¶åº”ç”¨æ–°æƒé‡
    â†“
    è¾“å‡º: é¡¶ç‚¹10çš„æƒé‡å·²å¹³æ»‘ */
    
    fn fn_blendVerticesWeight vidList valList = (
        if vidList.count > 0 do 
        (
            local affectedVerts = fn_meshGetAffectedVerts vidList
            local affectedVertsWeightsList = #()
            for vid in affectedVerts do
            (
                affectedVertsWeightsList[vid] = fn_getVertexWeights vid
            )
            for i = 1 to vidList.count do 
            (
                local vid = vidList[i]
                local val = valList[i]
                if val > 0.001 do 
                (
                    local dval = 1 - val
                    local selfWeights = affectedVertsWeightsList[vid]
                    local selfBoneList = selfWeights[1]
                    local selfWeightList = selfWeights[2]
                    if roundInfoList[vid] == undefined do
                        roundInfoList[vid] = fn_getVertRoundDisWeightsInfo vid
                    local newBones = #()
                    local newWeights = #()
                    local roundInfo = roundInfoList[vid]
                    local roundVid = roundInfo[1]
                    for j = 1 to roundVid.count do (
                        local rid = roundVid[j]
                        local disW = 1.0 / roundVid.count
                        local rWeights = affectedVertsWeightsList[rid]
                        local rvb = rWeights[1]
                        local rvw = rWeights[2]
                        for id = 1 to rvb.count do (
                            local w = rvw[id] * disW
                            local blid = findItem newBones rvb[id]
                            if blid > 0 then
                                newWeights[blid] += w
                            else (
                                append newBones rvb[id]
                                append newWeights w
                            )
                        )
                    )
                    if newWeights.count > 0 do 
                    (
                        local totalWeight = fn_sumArray newWeights
                        for j = 1 to newWeights.count do
                            newWeights[j] = (newWeights[j] / totalWeight) * val
                        for id = 1 to selfBoneList.count do 
                        (
                            local bid = selfBoneList[id]
                            local w = selfWeightList[id] * dval
                            local blid = findItem newBones bid
                            if blid > 0 then
                                newWeights[blid] += w
                            else 
                            (
                                append newBones bid
                                append newWeights w
                            )
                        )
                        fn_skinReplaceVertexWeights currentSkinMod vid newBones newWeights
                    )
                )
            )
        )
    )
    fn fn_CircleLine axisPoint angle radius width = (
        local scaleRadius = (getViewFOV() / 10.0 * radius)
        local halfSize = scaleRadius
        local lineWidth = (getViewFOV() / 10.0 * width)
        
        gw.setRndLimits #(#colorVerts,#flat,#twoSided)
        
        local tran = Inverse(getViewTM())
        tran.row4 = axisPoint
        gw.settransform tran
        
        local topLeft = [-halfSize, halfSize, 0]
        local topRight = [halfSize, halfSize, 0]
        local bottomLeft = [-halfSize, -halfSize, 0]
        local bottomRight = [halfSize, -halfSize, 0]
        
        local offset1 = normalize(topRight - bottomLeft)
        local perpOffset1 = [-offset1.y, offset1.x, 0] * lineWidth * 0.5
        
        local offset2 = normalize(topLeft - bottomRight)
        local perpOffset2 = [-offset2.y, offset2.x, 0] * lineWidth * 0.5
        
        gw.startTriangles()
        
        local line1_p1 = topLeft + perpOffset2
        local line1_p2 = topLeft - perpOffset2
        local line1_p3 = bottomRight + perpOffset2
        local line1_p4 = bottomRight - perpOffset2
        
        gw.triangle #(line1_p1, line1_p2, line1_p3) #(green, green, green)
        gw.triangle #(line1_p2, line1_p4, line1_p3) #(green, green, green)
        
        local line2_p1 = topRight + perpOffset1
        local line2_p2 = topRight - perpOffset1
        local line2_p3 = bottomLeft + perpOffset1
        local line2_p4 = bottomLeft - perpOffset1
        
        gw.triangle #(line2_p1, line2_p2, line2_p3) #(green, green, green)
        gw.triangle #(line2_p2, line2_p4, line2_p3) #(green, green, green)
        
        gw.endTriangles()

        gw.settransform (matrix3 1)
    )
    -- è§†å£ç»˜åˆ¶å›è°ƒå‡½æ•°
    fn fn_drawMarkers = (
        try (
            if markedVertices.count > 0 and currentObj != undefined and isValidNode currentObj then (
                for vertData in markedVertices do (
                    local vertIndex = vertData[1]
                    local obj = vertData[2]
                    if isValidNode obj then 
                    (
                        try 
                        (
                            --local vertPos = polyop.getVert obj vertIndex
                            vertPos = case (classof obj) of
                            (
                                PolyMeshObject: polyop.getVert obj vertIndex
                                Editable_mesh: getVert obj vertIndex
                            )
                            fn_CircleLine vertPos 90 0.3 0.1 
                            -- å‚æ•°è¯´æ˜ï¼š
                            -- 0.5 = X çš„å¤§å°
                            -- 0.1 = çº¿æ¡ç²—ç»†ï¼ˆæ•°å€¼è¶Šå¤§è¶Šç²—ï¼‰
                        ) catch()
                    )
                )
                gw.enlargeUpdateRect #whole
                gw.updateScreen()
            )
        ) catch 
        (
            markedVertices = #()
        )
    )
    fn registerViewportCallback = (
        unregisterRedrawViewsCallback fn_drawMarkers
        registerRedrawViewsCallback fn_drawMarkers
    )
    fn unregisterViewportCallback = (
        unregisterRedrawViewsCallback fn_drawMarkers
    )
    -- è·å–ä¸¤ä¸ªæ•°ç»„çš„äº¤é›†
    fn fn_getIntersection arr1 arr2 = (
        if arr1.count == 0 or arr2.count == 0 then return #()
        
        local result = #()
        local ba2 = arr2 as BitArray
        
        for item in arr1 do (
            if ba2[item] do
                append result item
        )
        return result
    )
    fn fn_getDifference arr1 arr2 = (
        if arr1.count == 0 then return #()
        if arr2.count == 0 then return deepCopy arr1
        
        local result = #()
        local ba2 = arr2 as BitArray
        
        for item in arr1 do (
            if not ba2[item] do
                append result item
        )
        return result
    )
    -- æ¯”è¾ƒä¸¤ä¸ªæ•°ç»„æ˜¯å¦ç›¸åŒ
    fn fn_arraysEqual arr1 arr2 = (
        if arr1.count != arr2.count then return false
        
        local ba1 = arr1 as BitArray
        local ba2 = arr2 as BitArray
        
        return (ba1 == ba2)
    )
    on SkinIslandChecker open do
    (
        fn_loadMyLogoAsTitlebarIcon()
        fn_initSelectionControl()
        fn_initListControl()
        fn_initLogControl()
        fn_addLog "é€‰æ‹©è’™çš®å¯¹è±¡,ç‚¹å‡»æ£€æŸ¥æŒ‰é’®å¼€å§‹" level:#success
        fn_addLog "å¯ä½¿ç”¨å·¦é”®/å³é”®ä¸¤ç§æ£€æŸ¥æ–¹å¼ã€‚" level:#success
        registerViewportCallback()
        pb3.value = 0
    )
    on SkinIslandChecker close do
    (
        unregisterViewportCallback()
    )
    on lst_problems DrawSubItem sender args do
    (
        local colorClass = dotNetClass "System.Drawing.Color"
        local itemIndex = args.Item.Index + 1
        
        local backColor = colorClass.FromArgb 43 43 43
        local textColor = colorClass.FromArgb 200 200 200
        
        if args.Item.Text == "âœ“ æ²¡æœ‰å‘ç°é—®é¢˜" then
        (
            textColor = colorClass.FromArgb 144 238 144 
        )
        else if itemIndex <= vertexDataMap.count then 
        (
            local data = vertexDataMap[itemIndex]
            -- éª¨éª¼æ ‡é¢˜è¡Œ
            if data[2] > 0 and data[3] == undefined then 
            (
                local boneName = data[1]
                local hasIgnored = false
                local hasFixed = false
                local hasUnfixed = false
                -- æ£€æŸ¥è¯¥éª¨éª¼ä¸‹çš„æ‰€æœ‰åŒºåŸŸçŠ¶æ€
                for i = (itemIndex + 1) to vertexDataMap.count do
                (
                    local childData = vertexDataMap[i]
                    -- å¦‚æœé‡åˆ°ä¸‹ä¸€ä¸ªéª¨éª¼æ ‡é¢˜ï¼Œé€€å‡º
                    if childData[1] != boneName or childData[3] == undefined then
                        exit
                    -- æ£€æŸ¥è¯¥åŒºåŸŸçš„é¡¶ç‚¹å“ˆå¸Œ
                    if childData[3] != undefined then
                    (
                        local regionHash = fn_getVertexHash boneName childData[3]
                        
                        if findItem ignoredRegions regionHash > 0 then
                            hasIgnored = true
                        else if findItem fixedRegions regionHash > 0 then
                            hasFixed = true
                        else
                            hasUnfixed = true
                    )
                )
                -- é¢œè‰²ä¼˜å…ˆçº§ï¼šæœ‰å¿½ç•¥(ç´«) > æœ‰æœªå¤„ç†(çº¢) > å…¨éƒ¨ä¿®å¤(ç»¿)
                if hasIgnored then
                    textColor = colorClass.FromArgb 200 150 255  -- ç´«è‰²
                else if hasUnfixed then
                    textColor = colorClass.FromArgb 255 100 100  -- çº¢è‰²
                else if hasFixed then
                    textColor = colorClass.FromArgb 144 238 144  -- ç»¿è‰²
            )
            -- é—®é¢˜åŒºåŸŸè¡Œ
            else if data[3] != undefined then
            (
                local boneName = data[1]
                local verts = data[3]
                local regionHash = fn_getVertexHash boneName verts
                -- ä¼˜å…ˆçº§ï¼šå·²å¿½ç•¥(ç´«) > å·²ä¿®å¤(ç»¿) > æœªå¤„ç†(ç°ç™½)
                if findItem ignoredRegions regionHash > 0 then 
                (
                    textColor = colorClass.FromArgb 200 150 255  -- ç´«è‰²
                )
                else if findItem fixedRegions regionHash > 0 then
                (
                    textColor = colorClass.FromArgb 144 238 144  -- ç»¿è‰²
                )
                else
                (
                    textColor = colorClass.FromArgb 200 200 200  -- ç°ç™½è‰²ï¼ˆæœªå¤„ç†ï¼‰
                )
            )
        )
        if args.Item.Selected then 
        (
            backColor = colorClass.FromArgb 100 100 100
        )
        local backBrush = dotNetObject "System.Drawing.SolidBrush" backColor
        args.Graphics.FillRectangle backBrush args.Bounds
        backBrush.Dispose()
        
        local textBrush = dotNetObject "System.Drawing.SolidBrush" textColor
        local sf = dotNetObject "System.Drawing.StringFormat"
        sf.LineAlignment = (dotNetClass "System.Drawing.StringAlignment").Center
        
        local rect = dotNetObject "System.Drawing.RectangleF" (args.Bounds.X + 3) args.Bounds.Y (args.Bounds.Width - 3) args.Bounds.Height
        args.Graphics.DrawString args.SubItem.Text args.Item.Font textBrush rect sf
        
        textBrush.Dispose()
    )
    on lst_problems MouseUp sender args do
    (
        try 
        (
            if args.Button == (dotNetClass "System.Windows.Forms.MouseButtons").Right then 
            (
                local hitTest = lst_problems.HitTest (dotNetObject "System.Drawing.Point" args.X args.Y)
                if hitTest.Item != undefined then 
                (
                    local index = hitTest.Item.Index
                    -- æ£€æŸ¥æ˜¯å¦ç‚¹å‡»çš„æ˜¯éª¨éª¼æ ‡é¢˜è¡Œ
                    if (index + 1) <= vertexDataMap.count then
                    (
                        local dataEntry = vertexDataMap[index + 1]
                        -- å¦‚æœæ˜¯éª¨éª¼æ ‡é¢˜è¡Œï¼Œä¸æ˜¾ç¤ºèœå•
                        if dataEntry[3] == undefined or dataEntry[2] == 0 then
                        (
                            fn_addLog "è¯·åœ¨å…·ä½“çš„é—®é¢˜åŒºåŸŸä¸Šå³é”®æ“ä½œ" level:#warning
                            return()
                        )
                    )
                    if not hitTest.Item.Selected then
                    (
                        hitTest.Item.Selected = true
                    )
                    if index < vertexDataMap.count then 
                    (
                        local dataEntry = vertexDataMap[index + 1]
                        if dataEntry[3] != undefined and dataEntry[2] > 0 then 
                        (
                            contextMenu.Show lst_problems (dotNetObject "System.Drawing.Point" args.X args.Y)
                        )
                    )
                )
            )
        ) 
        catch 
        (
            fn_addLog ("å³é”®èœå•é”™è¯¯: " + (getCurrentException())) level:#error
        )
    )
    on lst_problems ItemSelectionChanged sender args do
    (
        try
        (
            -- æ£€æŸ¥æ˜¯å¦é€‰ä¸­äº†éª¨éª¼æ ‡é¢˜è¡Œ
            if args.Item != undefined and args.IsSelected then
            (
                local index = args.Item.Index + 1
                if index <= vertexDataMap.count then
                (
                    local dataEntry = vertexDataMap[index]
                    -- å¦‚æœæ˜¯éª¨éª¼æ ‡é¢˜è¡Œï¼ˆæ²¡æœ‰é¡¶ç‚¹æ•°æ®ï¼‰ï¼Œå–æ¶ˆé€‰ä¸­
                    if dataEntry[3] == undefined or dataEntry[2] == 0 then
                    (
                        args.Item.Selected = false
                    )
                )
            )
        )
        catch()
    )
    on lst_problems DoubleClick sender args do
    (
        try
        (
            registerViewportCallback()
            if currentObj == undefined or currentSkinMod == undefined then 
            (
                fn_addLog "é”™è¯¯:è¯·å…ˆæ‰§è¡Œæ£€æŸ¥" level:#error
                return()
            )
            if lst_problems.SelectedItems.Count == 0 then return()
            local sel = lst_problems.SelectedItems.Item[0].Index + 1
            if sel <= 0 or sel > vertexDataMap.count then return()
            local dataEntry = vertexDataMap[sel]
            local boneName = dataEntry[1]
            local boneID = dataEntry[2]
            local verts = dataEntry[3]
            if verts == undefined or boneID == 0 then 
            (
                fn_addLog "é€‰æ‹©äº†éª¨éª¼æ ‡é¢˜æˆ–ç©ºè¡Œ,æ— æ³•è·³è½¬" level:#error
                return()
            )
            --è·³è½¬è’™çš®ç‚¹
            select currentObj
            max modify mode
            modPanel.setCurrentObject currentSkinMod
            subobjectLevel = 1
            skinOps.SelectBone currentSkinMod boneID 
            local vertBitArray = verts as BitArray
            skinOps.SelectVertices currentSkinMod vertBitArray
            markedVertices = #()
            for v in verts do 
            (
                append markedVertices #(v, currentObj)
            )
            completeRedraw()
            fn_addLog ("å·²è·³è½¬åˆ°ã€" + boneName + "ã€‘å¹¶é€‰æ‹©äº† " + verts.count as string + " ä¸ªé¡¶ç‚¹") level:#success 
        ) 
        catch 
        (
            errMsg = "è·³è½¬å¤±è´¥: " + (getCurrentException()) 
            fn_addLog errMsg level:#error
        )
    )
    on contextMenu ItemClicked sender args do
    (
        local menuIndex = contextMenu.Items.IndexOf args.ClickedItem
        --é€‰æ‹©
        if menuIndex == 0 then
        (
            try
            (
                if currentObj == undefined or currentSkinMod == undefined then 
                (
                    fn_addLog "é”™è¯¯: è¯·å…ˆæ‰§è¡Œæ£€æŸ¥" level:#error
                    return()
                )
                if lst_problems.SelectedIndices.Count == 0 then 
                (
                    fn_addLog "é”™è¯¯: æœªé€‰æ‹©æœ‰æ•ˆé¡¹" level:#warning
                    return()
                )
                -- æ”¶é›†æ‰€æœ‰é€‰ä¸­é¡¹å¯¹åº”çš„é¡¶ç‚¹
                local allSelectedVerts = #()
                local selectedRegionCount = 0
                
                for i = 0 to (lst_problems.SelectedIndices.Count - 1) do
                (
                    local sel = lst_problems.SelectedIndices.Item[i] + 1
                    
                    if sel > 0 and sel <= vertexDataMap.count then
                    (
                        local dataEntry = vertexDataMap[sel]
                        local verts = dataEntry[3]
                        
                        -- åªå¤„ç†æœ‰é¡¶ç‚¹æ•°æ®çš„æ¡ç›®ï¼ˆè·³è¿‡éª¨éª¼æ ‡é¢˜è¡Œï¼‰
                        if verts != undefined and verts.count > 0 then
                        (
                            selectedRegionCount += 1
                            for v in verts do
                            (
                                if findItem allSelectedVerts v == 0 do
                                    append allSelectedVerts v
                            )
                        )
                    )
                )
                if allSelectedVerts.count == 0 then
                (
                    fn_addLog "æ‰€é€‰é¡¹ä¸­æ²¡æœ‰é¡¶ç‚¹æ•°æ®" level:#warning
                    return()
                )
                -- é€‰æ‹©å¯¹è±¡å¹¶è¿›å…¥ä¿®æ”¹æ¨¡å¼
                select currentObj
                max modify mode
                modPanel.setCurrentObject currentSkinMod
                subobjectLevel = 1
                -- é€‰æ‹©æ‰€æœ‰æ”¶é›†åˆ°çš„é¡¶ç‚¹
                local vertBitArray = allSelectedVerts as BitArray
                skinOps.SelectVertices currentSkinMod vertBitArray
                -- æ ‡è®°æ‰€æœ‰é¡¶ç‚¹ï¼ˆç”¨äºè§†å£æ˜¾ç¤ºï¼‰
                markedVertices = #()
                for v in allSelectedVerts do
                (
                    append markedVertices #(v, currentObj)
                )
                -- æ³¨å†Œè§†å£å›è°ƒä»¥æ˜¾ç¤ºæ ‡è®°
                registerViewportCallback()
                completeRedraw()
                
                fn_addLog ("å·²é€‰æ‹© " + selectedRegionCount as string + " ä¸ªåŒºåŸŸï¼Œå…± " + allSelectedVerts.count as string + " ä¸ªé¡¶ç‚¹") level:#success
                --fn_addLog "ç»¿è‰²æ ‡è®°å·²åœ¨è§†å£ä¸­æ˜¾ç¤º" level:#info
            )
            catch
            (
                local errMsg = "é€‰æ‹©é¡¶ç‚¹å¤±è´¥: " + (getCurrentException())
                fn_addLog errMsg level:#error
            )
        )
        --ä¿®å¤
        if menuIndex == 1 then  
        (
            if lst_problems.SelectedIndices.Count == 0 then 
            (
                fn_addLog "é”™è¯¯: æœªé€‰æ‹©æœ‰æ•ˆé¡¹" level:#error
                return()
            )
            -- æ”¶é›†æ‰€æœ‰é€‰ä¸­çš„æœ‰æ•ˆåŒºåŸŸ
            local validRegions = #()
            for i = 0 to (lst_problems.SelectedIndices.Count - 1) do
            (
                local sel = lst_problems.SelectedIndices.Item[i] + 1
                
                if sel > 0 and sel <= vertexDataMap.count then
                (
                    local dataEntry = vertexDataMap[sel]
                    local boneName = dataEntry[1]
                    local boneID = dataEntry[2]
                    local verts = dataEntry[3]
                    
                    -- åªå¤„ç†æœ‰é¡¶ç‚¹æ•°æ®çš„æ¡ç›®ï¼ˆè·³è¿‡éª¨éª¼æ ‡é¢˜è¡Œï¼‰
                    if verts != undefined and boneID > 0 then
                    (
                        append validRegions #(boneName, boneID, verts)
                    )
                )
            )
            if validRegions.count == 0 then
            (
                fn_addLog "é”™è¯¯: è¯·é€‰æ‹©å…·ä½“çš„åŒºåŸŸè¿›è¡Œä¿®å¤" level:#error
                return()
            )
            -- æ‰¹é‡ä¿®å¤
            fn_addLog ("å¼€å§‹æ‰¹é‡ä¿®å¤ " + validRegions.count as string + " ä¸ªé—®é¢˜åŒºåŸŸ...") level:#info
            
            local tempMesh = snapshotasmesh currentObj
            local originalObj = currentObj
            currentObj = tempMesh
            
            local totalVertCount = 0
            
            for regionData in validRegions do
            (
                local boneName = regionData[1]
                local boneID = regionData[2]
                local verts = regionData[3]
                
                fn_addLog ("  ä¿®å¤ã€" + boneName + "ã€‘åŒºåŸŸï¼ˆ" + verts.count as string + " ä¸ªé¡¶ç‚¹ï¼‰...") level:#info
                
                local vidList = verts
                local valList = #()
                for i = 1 to vidList.count do
                    append valList 1.0
                    
                for n = 1 to 50 do 
                (
                    -- åŠ¨æ€è°ƒæ•´å¼ºåº¦ï¼šå‰æœŸæ¿€è¿›ï¼ŒåæœŸæ¸©å’Œ
                    local blendStrength = case of
                    (
                        (n <= 10):  1.0    -- å‰10æ¬¡å…¨åŠ›å¹³æ»‘
                        (n <= 30):  0.7    -- ä¸­æœŸé€‚åº¦å¹³æ»‘
                        (n <= 50):  0.3    -- åæœŸå¾®è°ƒ
                        default:    0.1
                    )
                    -- æ›´æ–°æ‰€æœ‰é¡¶ç‚¹çš„æ··åˆå¼ºåº¦
                    for i = 1 to valList.count do
                        valList[i] = blendStrength
                    
                    fn_blendVerticesWeight vidList valList
                )
                -- ç”Ÿæˆè¯¥åŒºåŸŸçš„å“ˆå¸Œå¹¶æ·»åŠ åˆ°ä¿®å¤åˆ—è¡¨
                local regionHash = fn_getVertexHash boneName verts
                if findItem fixedRegions regionHash == 0 do
                    append fixedRegions regionHash
                -- ä»å¿½ç•¥åˆ—è¡¨ä¸­ç§»é™¤ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                local ignoreIdx = findItem ignoredRegions regionHash
                if ignoreIdx > 0 do
                    deleteItem ignoredRegions ignoreIdx
                totalVertCount += verts.count
            )
            currentObj = originalObj
            delete tempMesh
            lst_problems.Refresh()
            fn_addLog ("æ‰¹é‡ä¿®å¤å®Œæˆï¼å…±ä¿®å¤ " + validRegions.count as string + " ä¸ªåŒºåŸŸï¼Œ" + totalVertCount as string + " ä¸ªé¡¶ç‚¹") level:#success
        )
        --å¿½ç•¥
        if menuIndex == 2 then
        (
            if lst_problems.SelectedIndices.Count == 0 then 
            (
                fn_addLog "é”™è¯¯: æœªé€‰æ‹©æœ‰æ•ˆé¡¹" level:#error
                return()
            )
            -- æ”¶é›†æ‰€æœ‰é€‰ä¸­çš„æœ‰æ•ˆåŒºåŸŸ
            local validRegions = #()
            
            for i = 0 to (lst_problems.SelectedIndices.Count - 1) do
            (
                local sel = lst_problems.SelectedIndices.Item[i] + 1
                
                if sel > 0 and sel <= vertexDataMap.count then
                (
                    local dataEntry = vertexDataMap[sel]
                    local boneName = dataEntry[1]
                    local boneID = dataEntry[2]
                    local verts = dataEntry[3]
                    
                    -- åªå¤„ç†æœ‰é¡¶ç‚¹æ•°æ®çš„æ¡ç›®ï¼ˆè·³è¿‡éª¨éª¼æ ‡é¢˜è¡Œï¼‰
                    if verts != undefined and boneID > 0 then
                    (
                        append validRegions #(boneName, boneID, verts)
                    )
                )
            )
            if validRegions.count == 0 then
            (
                fn_addLog "é”™è¯¯: è¯·é€‰æ‹©å…·ä½“çš„åŒºåŸŸè¿›è¡Œå¿½ç•¥" level:#error
                return()
            )
            -- æ‰¹é‡å¿½ç•¥
            local ignoredCount = 0
            local alreadyIgnoredCount = 0
            local totalVertCount = 0
            
            for regionData in validRegions do
            (
                local boneName = regionData[1]
                local verts = regionData[3]
                local regionHash = fn_getVertexHash boneName verts
                -- æ·»åŠ åˆ°å¿½ç•¥åˆ—è¡¨
                if findItem ignoredRegions regionHash == 0 then
                (
                    append ignoredRegions regionHash
                    ignoredCount += 1
                    totalVertCount += verts.count
                    fn_addLog ("  å¿½ç•¥ã€" + boneName + "ã€‘åŒºåŸŸï¼ˆ" + verts.count as string + " ä¸ªé¡¶ç‚¹ï¼‰") level:#info
                )
                else
                (
                    alreadyIgnoredCount += 1
                )
            )
            lst_problems.Refresh()
            if ignoredCount > 0 then
                fn_addLog ("æ‰¹é‡å¿½ç•¥å®Œæˆï¼å…±å¿½ç•¥ " + ignoredCount as string + " ä¸ªåŒºåŸŸï¼Œ" + totalVertCount as string + " ä¸ªé¡¶ç‚¹") level:#success
            if alreadyIgnoredCount > 0 then
                fn_addLog ("å…¶ä¸­ " + alreadyIgnoredCount as string + " ä¸ªåŒºåŸŸå·²åœ¨å¿½ç•¥åˆ—è¡¨ä¸­") level:#warning
        )
        --å–æ¶ˆå¿½ç•¥
        if menuIndex == 3 then
        (
            if lst_problems.SelectedIndices.Count == 0 then 
            (
                fn_addLog "é”™è¯¯: æœªé€‰æ‹©æœ‰æ•ˆé¡¹" level:#error
                return()
            )
            -- æ”¶é›†æ‰€æœ‰é€‰ä¸­çš„æœ‰æ•ˆåŒºåŸŸ
            local validRegions = #()
            for i = 0 to (lst_problems.SelectedIndices.Count - 1) do
            (
                local sel = lst_problems.SelectedIndices.Item[i] + 1
                
                if sel > 0 and sel <= vertexDataMap.count then
                (
                    local dataEntry = vertexDataMap[sel]
                    local boneName = dataEntry[1]
                    local boneID = dataEntry[2]
                    local verts = dataEntry[3]
                    
                    -- åªå¤„ç†æœ‰é¡¶ç‚¹æ•°æ®çš„æ¡ç›®ï¼ˆè·³è¿‡éª¨éª¼æ ‡é¢˜è¡Œï¼‰
                    if verts != undefined and boneID > 0 then
                    (
                        append validRegions #(boneName, boneID, verts)
                    )
                )
            )
            if validRegions.count == 0 then
            (
                fn_addLog "é”™è¯¯: è¯·é€‰æ‹©å…·ä½“çš„åŒºåŸŸè¿›è¡Œå–æ¶ˆå¿½ç•¥" level:#error
                return()
            )
            -- æ‰¹é‡å–æ¶ˆå¿½ç•¥
            local unignoredCount = 0
            local notIgnoredCount = 0
            local totalVertCount = 0
            
            for regionData in validRegions do
            (
                local boneName = regionData[1]
                local verts = regionData[3]
                local regionHash = fn_getVertexHash boneName verts
                
                -- ä»å¿½ç•¥åˆ—è¡¨ä¸­ç§»é™¤
                local ignoreIdx = findItem ignoredRegions regionHash
                if ignoreIdx > 0 then
                (
                    deleteItem ignoredRegions ignoreIdx
                    unignoredCount += 1
                    totalVertCount += verts.count
                    fn_addLog ("  å–æ¶ˆå¿½ç•¥ã€" + boneName + "ã€‘åŒºåŸŸï¼ˆ" + verts.count as string + " ä¸ªé¡¶ç‚¹ï¼‰") level:#info
                )
                else
                (
                    notIgnoredCount += 1
                )
            )
            lst_problems.Refresh()
            
            if unignoredCount > 0 then
                fn_addLog ("æ‰¹é‡å–æ¶ˆå¿½ç•¥å®Œæˆï¼å…±å–æ¶ˆ " + unignoredCount as string + " ä¸ªåŒºåŸŸï¼Œ" + totalVertCount as string + " ä¸ªé¡¶ç‚¹") level:#success
            
            if notIgnoredCount > 0 then
                fn_addLog ("å…¶ä¸­ " + notIgnoredCount as string + " ä¸ªåŒºåŸŸæœ¬æ¥å°±ä¸åœ¨å¿½ç•¥åˆ—è¡¨ä¸­") level:#warning
        )
        --å…¨é€‰
        if menuIndex == 4 then
        (
            try
            (
                if vertexDataMap.count == 0 then
                (
                    fn_addLog "åˆ—è¡¨ä¸ºç©ºï¼Œæ²¡æœ‰é¡¹ç›®å¯é€‰æ‹©" level:#warning
                    return()
                )
                -- é€‰ä¸­æ‰€æœ‰æœ‰æ•ˆçš„é—®é¢˜åŒºåŸŸé¡¹ï¼ˆè·³è¿‡éª¨éª¼æ ‡é¢˜è¡Œï¼‰
                local selectedCount = 0
                
                -- æ¸…ç©ºå½“å‰é€‰æ‹©
                lst_problems.SelectedItems.Clear()
                -- éå†æ‰€æœ‰åˆ—è¡¨é¡¹
                for i = 0 to (lst_problems.Items.Count - 1) do
                (
                    if (i + 1) <= vertexDataMap.count then
                    (
                        local dataEntry = vertexDataMap[i + 1]
                        -- åªé€‰æ‹©æœ‰é¡¶ç‚¹æ•°æ®çš„æ¡ç›®ï¼ˆè·³è¿‡éª¨éª¼æ ‡é¢˜è¡Œï¼‰
                        if dataEntry[3] != undefined and dataEntry[2] > 0 then
                        (
                            lst_problems.Items.Item[i].Selected = true
                            selectedCount += 1
                        )
                    )
                )
                fn_addLog ("å·²åœ¨åˆ—è¡¨ä¸­é€‰ä¸­æ‰€æœ‰ " + selectedCount as string + " ä¸ªé—®é¢˜åŒºåŸŸ") level:#success
                fn_addLog "å¯ä»¥å³é”®è¿›è¡Œæ‰¹é‡æ“ä½œï¼ˆä¿®å¤/å¿½ç•¥/å–æ¶ˆå¿½ç•¥ï¼‰" level:#info
            )
            catch
            (
                local errMsg = "å…¨é€‰åˆ—è¡¨é¡¹å¤±è´¥: " + (getCurrentException())
                fn_addLog errMsg level:#error
            )
        )
    )
    fn fn_orderCheck useHighVersion:true checkMode:#probability = 
    (
        try 
        (
            if selection.count == 0 then 
            (
                fn_addLog "é”™è¯¯: æœªé€‰æ‹©å¯¹è±¡" level:#error
                return()
            )
            -- ========== åˆå§‹åŒ– ==========
            local savedIgnoredRegions = deepCopy ignoredRegions
            
            edt_log.Clear()
            lst_problems.Items.Clear()
            problemBones = #()
            vertexDataMap = #()
            markedVertices = #()
            roundInfoList = #()
            fixedRegions = #()
            pb3.value = 0
            
            ignoredRegions = savedIgnoredRegions
            
            local startTime = timestamp()
            
            -- å…³é—­æƒé‡å·¥å…·
            try 
            (
                if selection[1].modifiers[#Skin] != undefined then
                (
                    if useHighVersion then
                        skinOps.closeWeightTool selection[1].modifiers[#Skin] node:selection[1]
                    else
                        skinOps.closeWeightTool selection[1].modifiers[#Skin]
                )
            )
            catch()
            
            -- è®¾ç½®å½“å‰å¯¹è±¡
            currentObj = selection[1]
            edt_selection.Text = currentObj.name
            windows.processPostedMessages()
            
            -- æ—¥å¿—æç¤º
            if checkMode == #probability then
                fn_addLog "ä½¿ç”¨æ¦‚ç‡æ£€æŸ¥,ç²¾ç¡®åº¦é»˜è®¤ä¸º 2 " level:#success
            else
                fn_addLog "ä½¿ç”¨ç²¾ç¡®æ£€æŸ¥" level:#success
                
            fn_addLog ("å¼€å§‹æ£€æŸ¥å¯¹è±¡: " + currentObj.name) level:#success
            
            -- æ¸…ç†æ ‡è®°
            markedVertices = #()
            roundInfoList = #()
            completeRedraw()
            pb3.value = 0
            pb3.color = yellow
            
            -- æ ¹æ®æ¨¡å¼è®¾ç½®
            if not useHighVersion then
                select currentObj
            else
                max create mode
            
            -- ========== è·å– Skin ä¿®æ”¹å™¨ ==========
            currentSkinMod = undefined
            for m in currentObj.modifiers do 
            (
                if classOf m == Skin then 
                (
                    currentSkinMod = m
                    exit
                )
            )
            
            if currentSkinMod == undefined then 
            (
                fn_addLog "é”™è¯¯: å¯¹è±¡æ²¡æœ‰Skinä¿®æ”¹å™¨" level:#error
                return()
            )
            
            -- ========== åˆ›å»ºå¿«ç…§å¹¶é¢„å¤„ç† ==========
            pb3.value = 0
            fn_addLog "åˆ›å»ºç½‘æ ¼å¿«ç…§..." level:#success
            
            local snapshotMesh = undefined
            try 
            (
                snapshotMesh = snapshotasmesh currentObj
                if snapshotMesh == undefined do throw "å¿«ç…§åˆ›å»ºå¤±è´¥"
            ) 
            catch 
            (
                fn_addLog ("å¿«ç…§é”™è¯¯: " + (getCurrentException())) level:#error
                return()
            )
            
            pb3.value = 5
            windows.processPostedMessages()
            
            local numVerts = meshop.getNumVerts snapshotMesh
            local numFaces = meshop.getNumFaces snapshotMesh
            
            -- æ„å»ºé¡¶ç‚¹é‚»æ¥å…³ç³»
            local vertexRingBitArrays = #()
            for i = 1 to numVerts do 
                vertexRingBitArrays[i] = #{}
            
            local lastUpdateTime = 0
            for f = 1 to numFaces do
            (
                if mod f 500 == 0 then 
                (
                    local currentTime = timestamp()
                    if currentTime - lastUpdateTime > 100 then
                    (
                        pb3.value = 5 + (20.0 * f / numFaces) as integer
                        windows.processPostedMessages()
                        lastUpdateTime = currentTime
                    )
                )
                
                local face = meshop.getFace snapshotMesh f
                local v1 = face.x as integer
                local v2 = face.y as integer
                local v3 = face.z as integer
                
                vertexRingBitArrays[v1][v2] = true
                vertexRingBitArrays[v1][v3] = true
                vertexRingBitArrays[v2][v1] = true
                vertexRingBitArrays[v2][v3] = true
                vertexRingBitArrays[v3][v1] = true
                vertexRingBitArrays[v3][v2] = true
            )
            
            pb3.value = 25
            windows.processPostedMessages()
            
            -- è½¬æ¢ä¸ºæ•°ç»„ç¼“å­˜
            local vertexRingCache = #()
            for v = 1 to numVerts do
            (
                vertexRingCache[v] = vertexRingBitArrays[v] as array
                append vertexRingCache[v] v
            )
            vertexRingBitArrays = undefined
            
            fn_addLog "é¢„å¤„ç†å®Œæˆï¼Œå¼€å§‹æ£€æŸ¥éª¨éª¼..." level:#success
            
            -- ========== é‡ç½®æ•°æ®ç»“æ„ ==========
            problemBones = #()
            lst_problems.Items.Clear()
            vertexDataMap = #()
            
            -- ä½ç‰ˆæœ¬éœ€è¦è®¾ç½®ä¿®æ”¹é¢æ¿
            if not useHighVersion then
            (
                max modify mode
                modPanel.setCurrentObject currentSkinMod
                subobjectLevel = 1
            )
            
            -- è·å–éª¨éª¼æ•°é‡
            numSkinBone = if useHighVersion then 
                skinOps.GetNumberBones currentSkinMod node:currentObj 
            else 
                skinOps.GetNumberBones currentSkinMod
            
            -- ========== éå†æ¯ä¸ªéª¨éª¼ ==========
            lastUpdateTime = 0
            local allBoneProblems = #()  -- æ”¶é›†æ‰€æœ‰éª¨éª¼çš„é—®é¢˜æ•°æ®
            local hasIgnoredRegions = false  -- æ ‡è®°æ˜¯å¦å­˜åœ¨è¢«å¿½ç•¥çš„åŒºåŸŸ
            
            for num = 1 to numSkinBone do 
            (
                -- æ›´æ–°è¿›åº¦
                local currentTime = timestamp()
                if currentTime - lastUpdateTime > 100 then
                (
                    pb3.value = 25 + (70.0 * num / numSkinBone) as integer
                    lastUpdateTime = currentTime
                )
                
                -- è·å–éª¨éª¼åç§°
                local boneName = ""
                try
                (
                    boneName = if useHighVersion then
                        skinOps.GetBoneName currentSkinMod num 1 node:currentObj
                    else
                        skinOps.GetBoneName currentSkinMod num 1
                )
                catch
                (
                    boneName = "Bone_" + num as string
                )
                
                -- è·å–è¯¥éª¨éª¼å½±å“çš„é¡¶ç‚¹
                if useHighVersion then
                (
                    skinOps.SelectBone currentSkinMod num node:currentObj
                    skinOps.selectVerticesByBone currentSkinMod node:currentObj
                    local allSkinVerts = skinOps.GetSelectedVertices currentSkinMod node:currentObj
                )
                else
                (
                    skinOps.SelectBone currentSkinMod num
                    skinOps.selectVerticesByBone currentSkinMod
                    local allSkinVerts = fn_quickGetSelectedVerts currentSkinMod
                    subobjectLevel = 0
                )
                
                local errorAry = #()
                
                -- ========== åŒºåŸŸè¿é€šæ€§æ£€æŸ¥ ==========
                if allSkinVerts.count > 0 then 
                (
                    local allStableSets = #()
                    local remainingVerts = allSkinVerts as bitArray
                    local allSkinVertsBits = allSkinVerts as bitArray
                    
                    -- ä½¿ç”¨åŒºåŸŸç”Ÿé•¿ç®—æ³•åˆ†ç¦»ç‹¬ç«‹åŒºåŸŸ
                    while remainingVerts.count > 0 do 
                    (
                        local seedArray = remainingVerts as array
                        if seedArray.count == 0 then exit
                        
                        local seedVert = seedArray[1]
                        local region = #{seedVert}
                        local toExpand = #{seedVert}
                        local safeCounter = 0
                        local maxIterations = 100000
                        
                        -- åŒºåŸŸæ‰©å±•
                        while toExpand.count > 0 do
                        (
                            safeCounter += 1
                            if safeCounter > maxIterations then
                            (
                                fn_addLog ("è­¦å‘Š: éª¨éª¼ã€" + boneName + "ã€‘åŒºåŸŸæ‰©å±•è¶…æ—¶") level:#warning
                                exit
                            )
                            
                            local newVerts = #{}
                            local expandArray = toExpand as array
                            
                            for v in expandArray do
                            (
                                if v > 0 and v <= vertexRingCache.count then
                                (
                                    local neighborsArray = vertexRingCache[v]
                                    if neighborsArray != undefined then
                                    (
                                        local neighborsBits = neighborsArray as bitArray
                                        local validNeighbors = neighborsBits * allSkinVertsBits - region
                                        newVerts += validNeighbors
                                    )
                                )
                            )
                            
                            region += newVerts
                            toExpand = newVerts
                        )
                        
                        local regionArray = region as array
                        if regionArray.count > 0 then
                            append allStableSets regionArray
                        
                        remainingVerts -= region
                    )
                    
                    -- ========== é£ç‚¹åˆ¤æ–­é€»è¾‘ï¼ˆä¸¤ç§æ¨¡å¼ï¼‰==========
                    if allStableSets.count > 1 then 
                    (
                        if not useHighVersion then subobjectLevel = 1
                        
                        -- ========== æ‰¾å‡ºé¡¶ç‚¹æ•°æœ€å¤šçš„åŒºåŸŸï¼ˆä¸»åŒºåŸŸï¼‰==========
                        local maxCount = 0
                        local mainRegionIndex = 1
                        local maxCountIslands = #()
                        
                        -- ç¬¬ä¸€æ­¥ï¼šæ‰¾å‡ºæœ€å¤§é¡¶ç‚¹æ•°
                        for i = 1 to allStableSets.count do
                        (
                            if allStableSets[i].count > maxCount then
                            (
                                maxCount = allStableSets[i].count
                            )
                        )
                        
                        -- ç¬¬äºŒæ­¥ï¼šæ”¶é›†æ‰€æœ‰å…·æœ‰æœ€å¤§é¡¶ç‚¹æ•°çš„å²›
                        for i = 1 to allStableSets.count do
                        (
                            if allStableSets[i].count == maxCount then
                            (
                                append maxCountIslands i
                            )
                        )
                        
                        -- åˆ¤æ–­æ˜¯å¦æœ‰å¤šä¸ªå²›å…·æœ‰ç›¸åŒçš„æœ€å¤§é¡¶ç‚¹æ•°
                        local hasMultipleMaxIslands = (maxCountIslands.count > 1)
                        
                        if hasMultipleMaxIslands then
                        (
                            fn_addLog ("éª¨éª¼ã€" + boneName + "ã€‘æœ‰ " + allStableSets.count as string + " ä¸ªåŒºåŸŸï¼Œæœ‰ " + maxCountIslands.count as string + " ä¸ªåŒºåŸŸå…·æœ‰ç›¸åŒçš„æœ€å¤§é¡¶ç‚¹æ•°: " + maxCount as string + "ï¼ˆæ— æ³•ç¡®å®šé—®é¢˜ï¼‰") level:#warning
                        )
                        else
                        (
                            mainRegionIndex = maxCountIslands[1]
                            --fn_addLog ("éª¨éª¼ã€" + boneName + "ã€‘æœ‰ " + allStableSets.count as string + " ä¸ªå²›ï¼Œä¸»å²›: " + maxCount as string + " ä¸ªé¡¶ç‚¹") level:#info
                        )
                        
                        case checkMode of
                        (
                            -- ========== æ¦‚ç‡æ£€æŸ¥æ¨¡å¼ï¼šå¯¹éä¸»åŒºåŸŸåšä¸¤æ¬¡æ”¶ç¼© ==========
                            #probability: 
                            (
                                for i = 1 to allStableSets.count do 
                                (
                                    local shouldCheck = false
                                    
                                    -- å¦‚æœæœ‰å¤šä¸ªæœ€å¤§å²›ï¼Œæ‰€æœ‰å²›éƒ½éœ€è¦æ£€æŸ¥
                                    if hasMultipleMaxIslands then
                                    (
                                        shouldCheck = true
                                    )
                                    -- å¦‚æœåªæœ‰ä¸€ä¸ªæœ€å¤§å²›ï¼Œè·³è¿‡è¯¥ä¸»å²›
                                    else if i != mainRegionIndex then
                                    (
                                        shouldCheck = true
                                    )
                                    
                                    if shouldCheck then
                                    (
                                        local regionVerts = allStableSets[i]
                                        if regionVerts.count > 0 then
                                        (
                                            local regionBits = regionVerts as BitArray
                                            local shrunkVerts = #{}
                                            
                                            -- ç¬¬ä¸€æ¬¡æ”¶ç¼©
                                            if useHighVersion then
                                            (
                                                skinOps.SelectVertices currentSkinMod regionBits node:currentObj
                                                shrunkVerts = skinUtils.ShrinkSelection currentObj
                                                shrunkVerts = skinOps.GetSelectedVertices currentSkinMod node:currentObj
                                            )
                                            else
                                            (
                                                skinOps.SelectVertices currentSkinMod regionBits
                                                shrunkVerts = skinUtils.ShrinkSelection currentObj
                                                shrunkVerts = fn_quickGetSelectedVerts currentSkinMod
                                            )
                                            
                                            -- ç¬¬äºŒæ¬¡æ”¶ç¼©ï¼ˆå¦‚æœç¬¬ä¸€æ¬¡æ”¶ç¼©åè¿˜æœ‰é¡¶ç‚¹ï¼‰
                                            if shrunkVerts.count > 0 then
                                            (
                                                if useHighVersion then
                                                (
                                                    shrunkVerts = skinUtils.ShrinkSelection currentObj
                                                    shrunkVerts = skinOps.GetSelectedVertices currentSkinMod node:currentObj
                                                )
                                                else
                                                (
                                                    shrunkVerts = skinUtils.ShrinkSelection currentObj
                                                    shrunkVerts = fn_quickGetSelectedVerts currentSkinMod
                                                )
                                            )
                                            
                                            -- ä¸¤æ¬¡æ”¶ç¼©åä¸ºç©ºåˆ™è®¤ä¸ºæ˜¯é£ç‚¹
                                            if shrunkVerts.count == 0 then 
                                            (
                                                append errorAry regionVerts
                                                local islandType = if hasMultipleMaxIslands then "ï¼ˆç›¸åŒæœ€å¤§æ•°é‡ï¼‰" else "ï¼ˆæ¬¡è¦å²›ï¼‰"
                                                --fn_addLog ("  - å²› " + i as string + islandType + ": " + regionVerts.count as string + " ä¸ªé¡¶ç‚¹ï¼ˆä¸¤æ¬¡æ”¶ç¼©åä¸ºç©ºï¼Œæ ‡è®°ä¸ºé—®é¢˜ï¼‰") level:#warning
                                            )
                                            else
                                            (
                                                local islandType = if hasMultipleMaxIslands then "ï¼ˆç›¸åŒæœ€å¤§æ•°é‡ï¼‰" else "ï¼ˆæ¬¡è¦å²›ï¼‰"
                                                --fn_addLog ("  - å²› " + i as string + islandType + ": " + regionVerts.count as string + " ä¸ªé¡¶ç‚¹ï¼ˆä¸¤æ¬¡æ”¶ç¼©åè¿˜æœ‰ " + shrunkVerts.count as string + " ä¸ªé¡¶ç‚¹ï¼Œåˆ¤å®šä¸ºæ­£å¸¸ï¼‰") level:#info
                                            )
                                        )
                                    )
                                )
                            )
                            
                            -- ========== ç²¾ç¡®æ£€æŸ¥æ¨¡å¼ï¼šç›´æ¥åˆ¤æ–­éä¸»åŒºåŸŸä¸ºé£ç‚¹ ==========
                            #accurate: 
                            (
                                for i = 1 to allStableSets.count do
                                (
                                    local shouldMarkAsProblem = false
                                    
                                    -- å¦‚æœæœ‰å¤šä¸ªæœ€å¤§å²›ï¼Œæ‰€æœ‰å²›éƒ½æ ‡è®°ä¸ºé—®é¢˜
                                    if hasMultipleMaxIslands then
                                    (
                                        shouldMarkAsProblem = true
                                    )
                                    -- å¦‚æœåªæœ‰ä¸€ä¸ªæœ€å¤§å²›ï¼Œå…¶ä»–å²›æ ‡è®°ä¸ºé—®é¢˜
                                    else if i != mainRegionIndex then
                                    (
                                        shouldMarkAsProblem = true
                                    )
                                    
                                    if shouldMarkAsProblem then
                                    (
                                        local regionVerts = allStableSets[i]
                                        if regionVerts.count > 0 then
                                        (
                                            append errorAry regionVerts
                                            local islandType = if hasMultipleMaxIslands then "ï¼ˆç›¸åŒæœ€å¤§æ•°é‡ï¼‰" else "ï¼ˆæ¬¡è¦åŒºåŸŸï¼‰"
                                            fn_addLog ("  - åŒºåŸŸ " + i as string + islandType + ": " + regionVerts.count as string + " ä¸ªé¡¶ç‚¹ï¼ˆæ ‡è®°ä¸ºé—®é¢˜ï¼‰") level:#warning
                                        )
                                    )
                                )
                            )
                        )
                        
                        if not useHighVersion then subobjectLevel = 0
                    )
                )
                
                -- ========== æ”¶é›†é—®é¢˜åŒºåŸŸï¼ˆä½¿ç”¨æ•°ç»„ç»“æ„ï¼‰==========
                if errorAry.count > 0 then 
                (
                    local boneProblemsData = #(boneName, num, #())  -- [1]=éª¨éª¼å, [2]=éª¨éª¼ID, [3]=åŒºåŸŸæ•°ç»„
                    
                    for regionIndex = 1 to errorAry.count do 
                    (
                        local regionVerts = errorAry[regionIndex]
                        local regionHash = fn_getVertexHash boneName regionVerts
                        local isIgnored = findItem ignoredRegions regionHash > 0
                        
                        -- æ£€æŸ¥æ˜¯å¦æœ‰è¢«å¿½ç•¥çš„åŒºåŸŸ
                        if isIgnored do hasIgnoredRegions = true
                        
                        append boneProblemsData[3] #(regionVerts, regionHash, isIgnored)
                    )
                    
                    append allBoneProblems boneProblemsData
                )
            )
            
            -- ========== æ˜¾ç¤ºé—®é¢˜åŒºåŸŸï¼ˆæ ¹æ®æ˜¯å¦æœ‰å¿½ç•¥åŒºåŸŸå†³å®šå¤„ç†æ–¹å¼ï¼‰==========
            pb3.value = 95
            
            -- å¦‚æœæ²¡æœ‰è¢«å¿½ç•¥çš„åŒºåŸŸï¼Œç›´æ¥æŒ‰åŸæ¥çš„æ–¹å¼æ·»åŠ ï¼ˆé€Ÿåº¦å¿«ï¼‰
            if not hasIgnoredRegions then
            (
                for boneData in allBoneProblems do
                (
                    local boneName = boneData[1]
                    local boneID = boneData[2]
                    local regions = boneData[3]
                    
                    local boneItem = lst_problems.Items.Add ("ã€" + boneName + "ã€‘")
                    append vertexDataMap #(boneName, boneID, undefined)
                    
                    for regionIndex = 1 to regions.count do 
                    (
                        local regionVerts = regions[regionIndex][1]
                        
                        local item = lst_problems.Items.Add ("        åŒºåŸŸ " + regionIndex as string + ": " + regionVerts.count as string + " ä¸ªé—®é¢˜é¡¶ç‚¹")
                        append vertexDataMap #(boneName, boneID, regionVerts)
                    )
                    
                    lst_problems.EnsureVisible (lst_problems.Items.Count - 1)
                    fn_addLog (boneName + " å‘ç° " + regions.count as string + " ä¸ªé—®é¢˜åŒºåŸŸ") level:#warning
                )
            )
            else
            (
                -- å¦‚æœæœ‰è¢«å¿½ç•¥çš„åŒºåŸŸï¼Œè¿›è¡Œæ’åºï¼ˆæœ‰è¢«å¿½ç•¥åŒºåŸŸçš„éª¨éª¼æ”¾æœ€åï¼‰
                fn_addLog "æ£€æµ‹åˆ°ä¹‹å‰è¢«å¿½ç•¥çš„åŒºåŸŸï¼Œå°†è¿™äº›éª¨éª¼æ’åˆ—åˆ°åˆ—è¡¨åº•éƒ¨..." level:#info
                
                local normalBones = #()      -- è¿™ä¸ªéª¨éª¼ä¸‹æ²¡æœ‰ä»»ä½•è¢«å¿½ç•¥çš„åŒºåŸŸ
                local ignoredBones = #()     -- è¿™ä¸ªéª¨éª¼ä¸‹æœ‰è‡³å°‘ä¸€ä¸ªè¢«å¿½ç•¥çš„åŒºåŸŸ
                
                -- åˆ†ç±»éª¨éª¼ï¼šæ ¹æ®æ˜¯å¦åŒ…å«è¢«å¿½ç•¥çš„åŒºåŸŸ
                for boneData in allBoneProblems do
                (
                    local regions = boneData[3]
                    local hasIgnoredRegion = false
                    
                    -- æ£€æŸ¥è¿™ä¸ªéª¨éª¼ä¸‹æ˜¯å¦æœ‰è¢«å¿½ç•¥çš„åŒºåŸŸ
                    for regionData in regions do
                    (
                        local isIgnored = regionData[3]  -- è¿™æ˜¯ä¹‹å‰è¢«å¿½ç•¥è¿‡çš„
                        if isIgnored then
                        (
                            hasIgnoredRegion = true
                            exit
                        )
                    )
                    
                    -- æ ¹æ®æ˜¯å¦åŒ…å«è¢«å¿½ç•¥åŒºåŸŸæ¥åˆ†ç±»
                    if hasIgnoredRegion then
                        append ignoredBones boneData
                    else
                        append normalBones boneData
                )
                
                -- å…ˆæ·»åŠ æ²¡æœ‰è¢«å¿½ç•¥åŒºåŸŸçš„éª¨éª¼ï¼ˆæ˜¾ç¤ºåœ¨ä¸Šé¢ï¼‰
                for boneData in normalBones do
                (
                    local boneName = boneData[1]
                    local boneID = boneData[2]
                    local regions = boneData[3]
                    
                    local boneItem = lst_problems.Items.Add ("ã€" + boneName + "ã€‘")
                    append vertexDataMap #(boneName, boneID, undefined)
                    
                    for regionIndex = 1 to regions.count do 
                    (
                        local regionVerts = regions[regionIndex][1]
                        
                        local item = lst_problems.Items.Add ("        åŒºåŸŸ " + regionIndex as string + ": " + regionVerts.count as string + " ä¸ªé—®é¢˜é¡¶ç‚¹")
                        append vertexDataMap #(boneName, boneID, regionVerts)
                    )
                    
                    lst_problems.EnsureVisible (lst_problems.Items.Count - 1)
                    fn_addLog (boneName + " å‘ç° " + regions.count as string + " ä¸ªé—®é¢˜åŒºåŸŸï¼ˆæ–°é—®é¢˜ï¼‰") level:#warning
                )
                
                -- å†æ·»åŠ æœ‰è¢«å¿½ç•¥åŒºåŸŸçš„éª¨éª¼ï¼ˆæ˜¾ç¤ºåœ¨ä¸‹é¢ï¼‰
                for boneData in ignoredBones do
                (
                    local boneName = boneData[1]
                    local boneID = boneData[2]
                    local regions = boneData[3]
                    
                    local boneItem = lst_problems.Items.Add ("ã€" + boneName + "ã€‘")
                    append vertexDataMap #(boneName, boneID, undefined)
                    
                    local ignoredCount = 0
                    local normalCount = 0
                    
                    for regionIndex = 1 to regions.count do 
                    (
                        local regionVerts = regions[regionIndex][1]
                        local regionHash = regions[regionIndex][2]
                        local isIgnored = regions[regionIndex][3]
                        
                        local item = lst_problems.Items.Add ("        åŒºåŸŸ " + regionIndex as string + ": " + regionVerts.count as string + " ä¸ªé—®é¢˜é¡¶ç‚¹")
                        append vertexDataMap #(boneName, boneID, regionVerts)
                        
                        if isIgnored then
                        (
                            ignoredCount += 1
                            fn_addLog (boneName + " åŒºåŸŸ " + regionIndex as string + " å·²è¢«å¿½ç•¥ï¼ˆä¹‹å‰æ ‡è®°ï¼‰") level:#info
                        )
                        else
                        (
                            normalCount += 1
                        )
                    )
                    
                    fn_addLog (boneName + " å‘ç° " + regions.count as string + " ä¸ªé—®é¢˜åŒºåŸŸï¼ˆ" + normalCount as string + " ä¸ªæ–°é—®é¢˜ï¼Œ" + ignoredCount as string + " ä¸ªå·²å¿½ç•¥ï¼‰") level:#warning
                )
                
                if ignoredBones.count > 0 then
                    fn_addLog ("åŒ…å«è¢«å¿½ç•¥åŒºåŸŸçš„ " + ignoredBones.count as string + " ä¸ªéª¨éª¼å·²æ’åˆ—åœ¨åˆ—è¡¨åº•éƒ¨") level:#info
            )
            
            -- ========== æ¸…ç†å’Œç»“æœè¾“å‡º ==========
            delete snapshotMesh
            vertexRingCache = undefined
            gc light:true
            pb3.value = 100
            
            local endTime = timestamp()
            local elapsed = (endTime - startTime) / 1000.0
            local elapsedStr = formattedPrint elapsed format:".2f"
            
            fn_addLog ("å¤„ç†äº† " + numVerts as string + " ä¸ªé¡¶ç‚¹...")
            fn_addLog ("å¤„ç†äº† " + numFaces as string + " ä¸ªé¢...")
            fn_addLog ("éª¨éª¼æ•°é‡: " + numSkinBone as string) 
            
            if vertexDataMap.count > 0 then 
            (
                fn_addLog ("æ£€æŸ¥å®Œæˆ,å‘ç°é—®é¢˜ (ç”¨æ—¶: " + elapsedStr + " ç§’)") level:#success
                pb3.color = red 
            ) 
            else 
            (
                local item = lst_problems.Items.Add "âœ“ æ²¡æœ‰å‘ç°é—®é¢˜"
                item.ForeColor = (dotNetClass "System.Drawing.Color").FromArgb 144 238 144
                fn_addLog ("æ£€æŸ¥å®Œæˆ,æ²¡æœ‰å‘ç°é—®é¢˜ (ç”¨æ—¶: " + elapsedStr + " ç§’)") level:#success
                pb3.color = green 
            )
        )
        catch 
        (
            errMsg = "æ£€æŸ¥å‡ºé”™: " + (getCurrentException()) 
            fn_addLog errMsg level:#error
            pb3.value = 0
            pb3.color = red
        )
    )
    on btn_check pressed do
    (
        if fn_getMaxVersion() >= 2020 then
            fn_orderCheck useHighVersion:true checkMode:#probability
        else
            fn_orderCheck useHighVersion:false checkMode:#probability
    )
    on btn_check rightclick do
    (
        if fn_getMaxVersion() >= 2020 then
            fn_orderCheck useHighVersion:true checkMode:#accurate
        else
            fn_orderCheck useHighVersion:false checkMode:#accurate
    )
    on btn_clear pressed do
    (
        fn_clearIni()
    )
    on btn_clear rightclick do 
    (
        unregisterViewportCallback()
        fn_addLog ("æ¸…ç†é€‰æ‹©æ ‡è®°...") level:#success
    )
    on btn_help pressed do fn_helpText()
)
createDialog SkinIslandChecker backgroundColor:(color 68 68 68) fgcolor:[100,200,100] style:#(#style_titlebar, #style_border, #style_sysmenu, #style_minimizebox)
)